{% extends './base.html' %}

{% block body %}

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
<div class="col-md-12">
    <h1>{{ ref.ref_name }}</h1>
    <h4>{{ ref.author }}</h4>
    <hr>
</div>

<div class="col-md-8">
    <div class="ref-desc">
        <blockquote class="blockquote">
            {{ ref.desc }}
        </blockquote>
    </div>

    <h3>Comments</h3>
    <ul class="">
        {% for comment in ref.comment_set.all %}
        <li class="">
            <p class="m-b-0">
                {{ comment.comment_text }}
            </p>
            <footer class="blockquote-footer">
                {{ comment.speaker }}
            </footer>
        </li>
        {% endfor %}
    </ul>

    <h4>Related books</h4>

    <table class="table table-borderless" id="related-books">
        <tr>
            <th class="padded-lg">Prereqs</th>
            <td>
                <ul class="list-group">
                {% if ref.prereqs.count %}
                    {% for f in ref.prereqs.iterator %}

                    <li class="list-group-item"><a href="{% url 'refinator:ref_detail' f.id %}">{{ f.ref_name }}</a></li>
                    {% endfor %}
                {% else %}
                    <li class="list-group-item">No prerequisites!</li>
                {% endif %}
                </ul>
            </td>
        </tr>
        <tr>
            <th class="padded-lg">Read with</th>
            <td>
                <ul class="list-group">
                {% if ref.read_with.count %}
                    {% for f in ref.read_with.iterator %}

                    <li class="list-group-item"><a href="{% url 'refinator:ref_detail' f.id %}">{{ f.ref_name }}</a></li>
                    {% endfor %}
                {% else %}
                    <li class="list-group-item">None known.</li>
                {% endif %}
                </ul>
            </td>
        </tr>
        <tr>
            <th class="padded-lg">Followups</th>
            <td>
                <ul class="list-group">
                {% if ref.followups.count %}
                    {% for f in ref.followups.iterator %}

                    <li class="list-group-item"><a href="{% url 'refinator:ref_detail' f.id %}">{{ f.ref_name }}</a></li>
                    {% endfor %}
                {% else %}
                    <li class="list-group-item">You've reached the boundaries of human knowledge.</li>
                {% endif %}
                </ul>
            </td>
        </tr>

    </table>


</div>

<div class="col-md-4">

    <table class="table table-borderless">
        <tbody>
            <tr>
                <th class="vertical-center">
                    Download
                </th>
                <td>
                    <a class="btn btn-primary" href="{{ ref.url }}">
                        <span class="fa fa-cloud-download fa-lg" aria-hidden="true"> </span>
                        ({{ ref.size|filesizeformat }} {{ ref.filetype }})
                    </a>
                </td>
            </tr>
            <tr>
                <th>Tags</th>
                <td>
                    {% for tag in ref.tags.iterator %}
                    <!-- TODO link to tag -->

                    <span class="tag tag-default">
                        <i class="fa fa-tag fa-flip-horizontal" aria-hidden="true"></i>
                        {{ tag.tag_name }}
                    </span>
                    {% endfor %}
                </td>
            </tr>
            <tr>
                <th>
                    Added
                </th>

                <td>
                    {{ ref.added_date }}
                </td>
            </tr>
            <tr>
                <th class="vertical-center">
                    Votes
                </th>
                <td>

                    <div class="btn-group">
                        <button class="btn btn-primary-outline vote vote-up">
                            <span class="fa fa-thumbs-o-up" aria-hidden="true"></span>
                        </button>

                        <button class="btn btn-secondary" id="vote-count">
                            {{ ref.votes }}
                        </button>

                        <button class="btn btn-primary-outline vote vote-down">
                            <span class="fa fa-thumbs-o-down" aria-hidden="true"></span>
                        </button>
                    </div>
                </td>
            </tr>

        </tbody>
    </table>
</div>

<div class="col-md-8"></div>


<script type="text/javascript">
 jQuery(function($) {

     // Hook up our vote handlers
     $("button.vote").on('click', voteClick);

     function voteClick(event) {
         var voteLink, itemId;
         var voteLabel = document.getElementById('vote-count');

         // Regardless of the below, we handle the event, so "consume" it
         event.stopPropagation();
         event.preventDefault();

         voteLink = $(this);

         // See if the vote has already been done or is in progress
         if (voteLink.hasClass('done') || voteLink.hasClass('inprogress')) {
             // Ignore the click, possibly tell the user why
             return;
         }

         // Get the vote type
         voteType = voteLink.hasClass('vote-up') ? 'up' : 'down';

         // Get its ID
         itemId = {{ ref.id }};

         // If we didn't get an ID...
         if (!itemId) {
             // ...report error
             return;
         }

         // Mark "in progress" and initiate the vote; action continues
         // in our callbacks below
         voteLink.addClass('btn-disabled');
         $.ajax({
             url:     "/{{ ref.id }}/vote/" + voteType + "/",
             type:    'POST',
             success: votePostSuccess,
             error:   votePostError
         });

         // Called when the POST is successful
         function votePostSuccess(response) {
             // The POST worked
             var delta = 0;
             voteLink.removeClass('inprogress');

             voteLink.addClass('done');
             if (voteType === 'up') {
                 delta = 1;
             } else {
                 delta = -1;
             }

             voteLabel.innerText = delta + parseInt(voteLabel.innerText);
         }

         // Called when the POST fails for some reason (HTTP errors)
         function votePostError(xhr, statusText, err) {
             // Not in progress anymore
             voteLink.removeClass('inprogress');

             // Report error to user
         }
     }
 });
</script>


{% endblock %}
